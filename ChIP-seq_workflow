#ChIP-seq ANALYSIS

#Library construction, base calling, and peak calling were performed according to Active Motif company protocol.
#bigWig files were generated by Active Motif
#Differential peak analysis carried out in R



###DIFFERENTIAL PEAK ANALYSIS
#Use H3K27ac for example workflow

library(DiffBind)
library(tidyverse)
library(DESeq2)
library(readr)
library(rtracklayer)
library(dplyr)
library(tidyr)
set.seed(725)


##Use Diffbind to load in peakset, normalize, and count reads in intervals

sampleSheet_k27 <- read.csv("diffbind_samplesheet_k27.csv", header=TRUE)

k27_dba <- dba(sampleSheet=sampleSheet_k27,
             minOverlap = 2,
             config = data.frame(AnalysisMethod=DBA_DESEQ2,
                                 DataType=DBA_DATA_GRANGES,
                                 minQCth=25, fragmentSize=200,
                                 bUsePval = FALSE),
             attributes = DBA_CONDITION,
             bRemoveM=TRUE,
             bRemoveRandom=TRUE,
             dir="~/BAM_files")

#remove blacklist.Use peakdata/peakdata.BL to check blacklist exclusions
peakdata <- dba.show(k27_dba)$Intervals

k27_dba <- dba.blacklist(k27_dba, blacklist= DBA_BLACKLIST_MM10, greylist=FALSE)

peakdata.BL <- dba.show(k27_dba)$Intervals
excludedBL <- peakdata - peakdata.BL
excludedBL

#count reads in peaks. Remove PCR duplicate
k27_dba <- dba.count(k27_dba, 
                     minOverlap = 2,
                     score=DBA_SCORE_READS,
                     fragmentSize = 200, 
                     mapQCth = 25,
                     summits = TRUE,
                     bRemoveDuplicates =TRUE,
                     bUseSummarizeOverlaps=FALSE)           

#check FRiP
info <- dba.show(k27_dba)
libsizes <- cbind(LibReads=info$Reads, FRiP=info$FRiP,
                  PeakReads=round(info$Reads * info$FRiP))
rownames(libsizes) <- info$ID
libsizes

#normalize. Use the DESeq RLE method with a full library, no binned background calculation
#typically DESeq only counts reads mapped to peaks ("genes"), using full library is better normalization for ChIP
k27_dba <- dba.normalize(k27_dba, normalize= DBA_NORM_RLE,
                         library= DBA_LIBSIZE_FULL, background = FALSE )

#check normalization output
norm <- dba.normalize(k27_dba, bRetrieve = TRUE)
normlibs <- cbind(FullLibSize=norm$lib.sizes, NormFacs=norm$norm.factors, 
                  NormLibSize=round(norm$lib.sizes/norm$norm.factors))
rownames(normlibs) <- info$ID
normlibs

#set up contrast and analysis 
k27_dba <- dba.contrast(k27_dba,
                        minMembers=2,
                        categories=DBA_CONDITION)


##create RangedSummarizedExperiment for DESeq2 differential analysis
rangedCounts <- dba.peakset(k27_dba, score=DBA_SCORE_READS, bRetrieve=TRUE)
counts <- as.matrix(mcols(rangedCounts))
rowRanges<-GRanges(rangedCounts)
sampleNames <- c("9548wt_k27", "9587wt_k27", "9588cpt_k27", "9589cpt_k27", "6833ppar_k27", "6834ppar_k27", "6843dko_k27", "6848ko_k27")
sampleGeno <- c("wt", "wt", "cpt2", "cpt2", "ppar", "ppar", "dko", "dko")
colData<-data.frame(sampleName=sampleNames, genotype=sampleGeno)
k27SumExp <- SummarizedExperiment(assays = list(counts=counts), rowRanges=rowRanges, colData=colData)

n <- k27_dba$totalMerged 
prefix <- "k27region_"
suffix <- seq(1:n)
npeaks <- paste(prefix, suffix, sep="" )
rownames(k27SumExp) <- npeaks


##pass RangeSummarizedExperiment to DESeq2 for differential peak analysis

ddsK27 <- DESeqDataSet(k27SumExp, design = ~genotype)
ddsK27$genotype <- factor(ddsK27$genotype,
                          levels = c("wt", "cpt2", "ppar", "dko"))

ddsK27 <- DESeq(ddsK27,
                test = c("Wald"),
                betaPrior = FALSE) 
ddsK27 <- ddsK27[rowSums(counts(ddsK27)) >1, ]

resultsNames(ddsK27)
shrinkCPT_WT <- lfcShrink(ddsK27, coef=2,
                           format = c("GRangesList"))
shrinkPPAR_WT <- lfcShrink(ddsK27, coef=3,
                           format = c("GRangesList"))
shrinkDKO_WT <- lfcShrink(ddsK27, coef=4,
                           format = c("GRangesList"))

#reorder reference factor too look at fold change Cpt2/DKO & Ppara/DKO 
ddsK27$genotype <- factor(ddsK27$genotype,
                           levels = c("dko", "wt", "cpt2", "ppar"))
ddsK27<- nbinomWaldTest(ddsK27)
resultsNames(ddsK27)

shrinkCPT_DKO <- lfcShrink(ddsK27, coef=3,
                          format = c("GRangesList"))
shrinkPPAR_DKO <- lfcShrink(ddsK27, coef=4,
                           format = c("GRangesList"))

#generate list of peak IDs with their DESeq2 count values
assayCounts <- as.data.frame(ddsK27@assays@data@listData[["counts"]])
assayCounts$peakName <- row.names(assayCounts)

#create master DE list w/ counts
k27_cptwt <- as.data.frame(shrinkCPT_WT)
colnames(k27_cptwt) <- c("chr", "start","end","width","strand","baseMean_cpt/wt",
                        "lfcShrink_cpt/wt","lfcSE_cpt/wt","pval_cpt/wt","padj_cpt/wt")
k27_cptwt$peakName <- row.names(k27_cptwt)

k27_pparwt <- as.data.frame(shrinkPPAR_WT)
colnames(k27_pparwt) <- c("chr", "start","end","width","strand","baseMean_ppar/wt",
                        "lfcShrink_ppar/wt","lfcSE_ppar/wt","pval_ppar/wt","padj_ppar/wt")
k27_pparwt$peakName <- row.names(k27_pparwt)
k27_pparwt <- k27_pparwt[,6:11]

k27_dkowt <- as.data.frame(shrinkDKO_WT)
colnames(k27_dkowt) <- c("chr", "start","end","width","strand","baseMean_dko/wt",
                         "lfcShrink_dko/wt","lfcSE_dko/wt","pval_dko/wt","padj_dko/wt")
k27_dkowt$peakName <- row.names(k27_cptwt)
k27_dkowt <- k27_dkowt[,6:11]

k27_cptdko <- as.data.frame(shrinkCPT_DKO)
colnames(k27_cptdko) <- c("chr", "start","end","width","strand","baseMean_cpt/dko",
                        "lfcShrink_cpt/dko","lfcSE_cpt/dko","pval_cpt/dko","padj_cpt/dko")
k27_cptdko$peakName <- row.names(k27_cptdko)
k27_cptdko <- k27_cptdko[,6:11]

k27_ppardko <- as.data.frame(shrinkPPAR_DKO)
colnames(k27_ppardko) <- c("chr", "start","end","width","strand","baseMean_ppar/dko",
                         "lfcShrink_ppar/dko","lfcSE_ppar/dko","pval_ppar/dko","padj_ppar/dko")
k27_ppardko$peakName <- row.names(k27_ppardko)
k27_ppardko <- k27_ppardko[,6:11]

merge1 <- merge(k27_cptwt, k27_pparwt, by="peakName", all=TRUE, sort=FALSE)
merge2 <- merge(merge1, k27_dkowt, by="peakName", all=TRUE, sort=FALSE)
merge3 <- merge(merge2, k27_cptdko, by="peakName", all=TRUE, sort=FALSE)
merge4 <- merge(merge3, k27_ppardko, by="peakName", all=TRUE, sort=FALSE)
K27_fullDElist <- merge(merge4, assayCounts, by="peakName", all=TRUE, sort=FALSE)

#Full Differential Peak Analysis 
write.csv(K27_fullDElist, "K27_fullDElist.csv")


##GRanges for peak comparisons between genotypes
#Example workflow: Cpt2 > WT, Cpt2 < WT, Cpt2 ~ WT

allK27peaks <- as.data.frame(K27_fullDElist$peakName)
colnames(allK27peaks) <- c("peakName")
allK27granges <- K27_fullDElist[,2:4]
allK27granges$peakName <- K27_fullDElist$peakName

cptwt_upk27 <- subset(k27_cptwt, k27_cptwt$`lfcShrink_cpt/wt` >= 1 & k27_cptwt$`padj_cpt/wt` < 0.05)
cptwt_downk27 <- subset(k27_cptwt, k27_cptwt$`lfcShrink_cpt/wt` <= -1 & k27_cptwt$`padj_cpt/wt` < 0.05)
cptwt_a <- merge(cptwt_upk27, cptwt_downk27, by=c("peakName"), all=TRUE)
cptwt_nck27 <- anti_join(allK27peaks, cptwt_a, by="peakName") 
cptwt_nck27 <- left_join(cptwt_nck27, allK27granges, by=c("peakName"))
cptwt_nck27 <- left_join(cptwt_nck27, k27_cptwt, by=c("peakName"))

write.csv(cptwt_upk27, file="cptwt_upk27.csv")
write.csv(cptwt_downk27, file="cptwt_downk27.csv")
write.csv(cptwt_nck27, file="cptwt_nck27.csv")



###ADDITONAL ChIP PEAKSET PROCESSING IN R

##Pull out H3K27ac promoter peaks associated with RNA-seq clusters
#call RNA-seq cluster lists (allClust, clust1-6) from RNA-seq workflow
#K27splitPeaks contains Active Motif Peak annotations

K27_promoterPeaks <- K27splitPeaks[grep("upstream", K27splitPeaks$Position),]
K27_promoterPeaks2000 <- K27_promoterPeaks[which(K27_promoterPeaks$`Dist to Start` > -2001),]
K27_promoterPeaks_allClust <- inner_join(K27_promoterPeaks2000, allClust, by=c("GeneID" = "gene"))
K27_promoterPeaks_clust1 <- inner_join(K27_promoterPeaks2000, clust1, by=c("GeneID" = "symbol"))
K27_promoterPeaks_clust2 <- inner_join(K27_promoterPeaks2000, clust2, by=c("GeneID" = "symbol"))
K27_promoterPeaks_clust3 <- inner_join(K27_promoterPeaks2000, clust3, by=c("GeneID" = "symbol"))
K27_promoterPeaks_clust4 <- inner_join(K27_promoterPeaks2000, clust4, by=c("GeneID" = "symbol"))
K27_promoterPeaks_clust5 <- inner_join(K27_promoterPeaks2000, clust5, by=c("GeneID" = "symbol"))
K27_promoterPeaks_clust6 <- inner_join(K27_promoterPeaks2000, clust6, by=c("GeneID" = "symbol"))

write.csv(K27_promoterPeaks_allClust, "K27_promoterPeaks_clusters.csv")
write.csv(K27_promoterPeaks_clust1, "K27_promoterPeaks_cluster1.csv")
write.csv(K27_promoterPeaks_clust3, "K27_promoterPeaks_cluster3.csv")


##PCA Plot
#rlog transformation for downstream visualization
k27_rlog <- rlog(ddsK27, blind=TRUE)
K27DEvalues <- as.data.frame(assay(k27_rlog))
rownames(K27DEvalues) <- rownames(k27_rlog)

pcaplot(k27_rlog, intgroup="genotype",
        text_labels = FALSE, point_size = 2)



###BAM FILE PROCESSING USING samtools AND bamtools
##H3K27ac used for example workflow

#index unprocessed BAM before proceeding
samtools index -b 09_9548-WT_H3K27ac_mm10.bam 
samtools index -b 10_9587-WT_H3K27ac_mm10.bam  
samtools index -b 11_9588-Cpt2_H3K27ac_mm10.bam  
samtools index -b 12_9589-Cpt2_H3K27ac_mm10.bam 
samtools index -b 13_6833-Ppara_H3K27ac_mm10.bam 
samtools index -b 14_6834-Ppara_H3K27ac_mm10.bam
samtools index -b 15_6843-DKO_H3K27ac_mm10.bam 
samtools index -b 16_6848-DKO_H3K27ac_mm10.bam 

#filter out only mapped reads and set mapq score > 25
samtools view -b -q 25 -F 4 09_093K_0195JHU_9548-WT_H3K27ac_mm10_i85.bam > 09_9548-WT_H3K27ac_mm10_map.bam 
samtools view -b -q 25 -F 4 10_093L_0195JHU_9587-WT_H3K27ac_mm10_i86.bam > 10_9587-WT_H3K27ac_mm10_map.bam 
samtools view -b -q 25 -F 4 11_093M_0195JHU_9588-Cpt2_H3K27ac_mm10_i87.bam > 11_9588-Cpt2_H3K27ac_mm10_map.bam 
samtools view -b -q 25 -F 4 12_093N_0195JHU_9589-Cpt2_H3K27ac_mm10_i88.bam > 12_9589-Cpt2_H3K27ac_mm10_map.bam 
samtools view -b -q 25 -F 4 13_093O_0195JHU_6833-Ppara_H3K27ac_mm10_i89.bam > 13_6833-Ppara_H3K27ac_mm10_map.bam 
samtools view -b -q 25 -F 4 14_093P_0195JHU_6834-Ppara_H3K27ac_mm10_i90.bam > 14_6834-Ppara_H3K27ac_mm10_map.bam 
samtools view -b -q 25 -F 4 15_093Q_0195JHU_6843-DKO_H3K27ac_mm10_i91.bam > 15_6843-DKO_H3K27ac_mm10_map.bam 
samtools view -b -q 25 -F 4 16_093R_0195JHU_6848-DKO_H3K27ac_mm10_i92.bam > 16_6848-DKO_H3K27ac_mm10_map.bam 

#index mapped reads for further processing
samtools index -b 09_9548-WT_H3K27ac_mm10_map.bam 
samtools index -b 10_9587-WT_H3K27ac_mm10_map.bam  
samtools index -b 11_9588-Cpt2_H3K27ac_mm10_map.bam  
samtools index -b 12_9589-Cpt2_H3K27ac_mm10_map.bam 
samtools index -b 13_6833-Ppara_H3K27ac_mm10_map.bam 
samtools index -b 14_6834-Ppara_H3K27ac_mm10_map.bam
samtools index -b 15_6843-DKO_H3K27ac_mm10_map.bam 
samtools index -b 16_6848-DKO_H3K27ac_mm10_map.bam 

#remove reads with more than 2 mismatches
bamtools filter -tag XM:2 -in 09_9548-WT_H3K27ac_mm10_map.bam -out 09_9548-WT_H3K27ac_mm10_map_m2.bam
bamtools filter -tag XM:2 -in 10_9587-WT_H3K27ac_mm10_map.bam.bam -out 10_9587-WT_H3K27ac_mm10_map.bam_m2.bam
bamtools filter -tag XM:2 -in 11_9588-Cpt2_H3K27ac_mm10_map.bam -out 11_9588-Cpt2_H3K27ac_mm10_map_m2.bam
bamtools filter -tag XM:2 -in 12_9589-Cpt2_H3K27ac_mm10_map.bam -out 12_9589-Cpt2_H3K27ac_mm10_map_m2.bam 
bamtools filter -tag XM:2 -in 13_6833-Ppara_H3K27ac_mm10_map.bam -out 13_6833-Ppara_H3K27ac_mm10_map_m2.bam
bamtools filter -tag XM:2 -in 14_6834-Ppara_H3K27ac_mm10_map.bam -out 14_6834-Ppara_H3K27ac_mm10_map_m2.bam
bamtools filter -tag XM:2 -in 15_6843-DKO_H3K27ac_mm10_map.bam -out 15_6843-DKO_H3K27ac_mm10_map_m2.bam
bamtools filter -tag XM:2 -in 16_6848-DKO_H3K27ac_mm10_map.bam -out 16_6848-DKO_H3K27ac_mm10_map_m2.bam

#index mapped reads for further processing
samtools index -b 09_9548-WT_H3K27ac_mm10_map_m2.bam 
samtools index -b 10_9587-WT_H3K27ac_mm10_map_m2.bam  
samtools index -b 11_9588-Cpt2_H3K27ac_mm10_map_m2.bam  
samtools index -b 12_9589-Cpt2_H3K27ac_mm10_map_m2.bam 
samtools index -b 13_6833-Ppara_H3K27ac_mm10_map_m2.bam 
samtools index -b 14_6834-Ppara_H3K27ac_mm10_map_m2.bam
samtools index -b 15_6843-DKO_H3K27ac_mm10_map_m2.bam 
samtools index -b 16_6848-DKO_H3K27ac_mm10_map_m2.bam 

#filter out chrM and chrUn
samtools view -b 09_9548-WT_H3K27ac_mm10_map.bam chr1 chr2 chr3 chr4 chr5 chr6 chr7 chr8 chr9 chr10 chr11 chr12 chr13 chr14 chr15 chr16 chr17 chr18 chr19 chrX chrY > 09_9548-WT_H3K27ac_mm10_map-filterM.bam
samtools view -b 10_9587-WT_H3K27ac_mm10_map.bam chr1 chr2 chr3 chr4 chr5 chr6 chr7 chr8 chr9 chr10 chr11 chr12 chr13 chr14 chr15 chr16 chr17 chr18 chr19 chrX chrY  > 10_9587-WT_H3K27ac_mm10_map-filterM.bam
samtools view -b 11_9588-Cpt2_H3K27ac_mm10_map.bam chr1 chr2 chr3 chr4 chr5 chr6 chr7 chr8 chr9 chr10 chr11 chr12 chr13 chr14 chr15 chr16 chr17 chr18 chr19 chrX chrY  > 11_9588-Cpt2_H3K27ac_mm10_map-filterM.bam
samtools view -b 12_9589-Cpt2_H3K27ac_mm10_map.bam  chr1 chr2 chr3 chr4 chr5 chr6 chr7 chr8 chr9 chr10 chr11 chr12 chr13 chr14 chr15 chr16 chr17 chr18 chr19 chrX chrY > 12_9589-Cpt2_H3K27ac_mm10_map-filterM.bam
samtools view -b 13_6833-Ppara_H3K27ac_mm10_map.bam chr1 chr2 chr3 chr4 chr5 chr6 chr7 chr8 chr9 chr10 chr11 chr12 chr13 chr14 chr15 chr16 chr17 chr18 chr19 chrX chrY  > 13_6833-Ppara_H3K27ac_mm10_map-filterM.bam
samtools view -b 14_6834-Ppara_H3K27ac_mm10_map.bam chr1 chr2 chr3 chr4 chr5 chr6 chr7 chr8 chr9 chr10 chr11 chr12 chr13 chr14 chr15 chr16 chr17 chr18 chr19 chrX chrY  > 14_6834-Ppara_H3K27ac_mm10_map-filterM.bam
samtools view -b 15_6843-DKO_H3K27ac_mm10_map.bam chr1 chr2 chr3 chr4 chr5 chr6 chr7 chr8 chr9 chr10 chr11 chr12 chr13 chr14 chr15 chr16 chr17 chr18 chr19 chrX chrY  > 15_6843-DKO_H3K27ac_mm10_map-filterM.bam 
samtools view -b 16_6848-DKO_H3K27ac_mm10_map.bam chr1 chr2 chr3 chr4 chr5 chr6 chr7 chr8 chr9 chr10 chr11 chr12 chr13 chr14 chr15 chr16 chr17 chr18 chr19 chrX chrY  > 16_6848-DKO_H3K27ac_mm10_map-fiterM.bam



###HOMER MOTIF ANALYSIS AND AGGREGATION PLOTS
#H3K27ac used for example workflow

##make tag directories for HOMER

#individual sample tag directories, use tbp -1 to remove PCR dupliates
makeTagDirectory 9548-WT_H3K27_tagDirectory/ 09_9548-WT_H3K27ac_mm10_map-filterM.bam -tbp 1
makeTagDirectory 9587-WT_H3K27_tagDirectory/ 10_9587-WT_H3K27ac_mm10_map-filterM.bam -tbp 1
makeTagDirectory 9588-Cpt2_H3K27_tagDirectory/ 11_9588-Cpt2_H3K27ac_mm10_map-filterM.bam -tbp 1
makeTagDirectory 9589-Cpt2_H3K27_tagDirectory/ 12_9589-Cpt2_H3K27ac_mm10_map-filterM.bam -tbp 1
makeTagDirectory 6833-Ppara_H3K27_tagDirectory/ 13_6833-Ppara_H3K27ac_mm10_map-filterM.bam -tbp 1
makeTagDirectory 6834-Ppara_H3K27_tagDirectory/ 14_6834-Ppara_H3K27ac_mm10_map-filterM.bam -tbp 1
makeTagDirectory 6843-DKO_H3K27_tagDirectory/ 15_6843-DKO_H3K27ac_mm10_map-filterM.bam -tbp 1
makeTagDirectory 6848-DKO_H3K27_tagDirectory/ 16_6848-DKO_H3K27ac_mm10_map-fiterM.bam -tbp 1

#combine tag directories for each genotype. Also use -fragLength 200 to set in silico read extension
makeTagDirectory WT_H3K27_tagDirectory/ -d 9548-WT_H3K27_tagDirectory/  9587-WT_H3K27_tagDirectory/ -fragLength 200
makeTagDirectory CPT2_H3K27_tagDirectory/ -d 9588-Cpt2_H3K27_tagDirectory/  9589-Cpt2_H3K27_tagDirectory/ -fragLength 200
makeTagDirectory PPARA_H3K27_tagDirectory/ -d 6833-Ppara_H3K27_tagDirectory/  6834-Ppara_H3K27_tagDirectory/ -fragLength 200
makeTagDirectory DKO_H3K27_tagDirectory/ -d 6843-DKO_H3K27_tagDirectory/ 6848-DKO_H3K27_tagDirectory/ -fragLength 200

#run -checkGC to assess any sequence bias
makeTagDirectory WT_H3K27_tagDirectory/ -update -genome mm10 -checkGC -fragLength 200
makeTagDirectory CPT2_H3K27_tagDirectory/ -update -genome mm10 -checkGC -fragLength 200
makeTagDirectory PPARA_H3K27_tagDirectory/ -update -genome mm10 -checkGC -fragLength 200 
makeTagDirectory DKO_H3K27_tagDirectory/ -update -genome mm10 -checkGC -fragLength 200


##Aggregation Plots

#All H3K27ac peaks, peak file input from Active Motif. Normalization is the lowest number of usable tags in a sample for a comparison group
annotatePeaks.pl AM_H3K27ac_mergedRegions.txt mm10 -size 2000 -hist 10 -d WT_H3K27_tagDirectory/ -norm 22273824 > WT_histogram_H3K27peaks.txt
annotatePeaks.pl AM_H3K27ac_mergedRegions.txt mm10 -size 2000 -hist 10 -d CPT2_H3K27_tagDirectory/ -norm 22273824 > CPT2_histogram_H3K27peaks.txt
annotatePeaks.pl AM_H3K27ac_mergedRegions.txt mm10 -size 2000 -hist 10 -d PPARA_H3K27_tagDirectory/ -norm 22273824  > PPARA_histogram_H3K27peaks.txt
annotatePeaks.pl AM_H3K27ac_mergedRegions.txt mm10 -size 2000 -hist 10 -d DKO_H3K27_tagDirectory/ -norm 22273824 > DKO_histogram_H3K27peaks.txt

#Genebodies
makeMetaGeneProfile.pl rna mm10 -gbin 300 -bin 100 -d WT_H3K27_tagDirectory/ CPT2_H3K27_tagDirectory/ PPARA_H3K27_tagDirectory/ DKO_H3K27_tagDirectory/ -norm 22273824 > h3k27_metageneProfile.txt

#RNA-seq cluster promoters
#use list of cluster genes and UCSC Table Browser refGene to obtain genomic coordinates for gene TSS
#For + strand use 'start_position'-5000 and 'end_position'+500
#For - strand use 'start_position'+5000 and 'end_position'-500
#use -size 6000 to get -5.5kb -> TSS -> +0.5bk

#cluster 1
annotatePeaks.pl clust1_Promotor_5kbFlank.txt mm10 -hist 10 -size 6000 -d WT_H3K27_tagDirectory/ CPT2_H3K27_tagDirectory/ PPARA_H3K27_tagDirectory/ DKO_H3K27_tagDirectory/ -norm 22273824 > clust1Promoter_K27hist_6000.txt

#cluster 3
annotatePeaks.pl clust3_Promotor_5kbFlank.txt mm10 -hist 10 -size 6000 -d WT_H3K27_tagDirectory/ CPT2_H3K27_tagDirectory/ PPARA_H3K27_tagDirectory/ DKO_H3K27_tagDirectory/ -norm 22273824 > clust3Promoter_K27hist_6000.txt



###IDENTIFY PROMOTER PEAKS FOR ENHANCER PIE CHARTS
#Define promotor: -2kb/+500bp. Use the UCSC RefSeq (refGene) set on Table Browser 
#download +500bp.bed, bedtools intersect w 2kbUpstream.bed from defining enhancers

##Define promoter GRanges
sort -k 1,1 -k2,2n mm10_promoter500bp.bed > mm10_promoter500bp_sort.bed
bedtools merge -i mm10_promoter500bp_sort.bed -d 10 > mm10_definedPromoters.bed


##Intersect with peak coordinates from differential analysis 
bedtools intersect -a cptwt_upk27.bed -b mm10_definedPromoters.bed -wa > cptwt_upk27Promoters.bed
bedtools intersect -a cptwt_downk27.bed -b mm10_definedPromoters.bed -wa > cptwt_downk27Promoters.bed
bedtools intersect -a cptwt_nck27.bed -b mm10_definedPromoters.bed -wa > cptwt_nck27EPromoters.bed

bedtools intersect -a pparwt_upk27.bed -b mm10_definedPromoters.bed -wa > pparwt_upk27Promoters.bed
bedtools intersect -a pparwt_downk27.bed -b mm10_definedPromoters.bed -wa > pparwt_downk27Promoters.bed
bedtools intersect -a pparwt_nck27.bed -b mm10_definedPromoters.bed -wa > pparwt_nck27Promoters.bed

bedtools intersect -a cptdko_upk27.bed -b mm10_definedPromoters.bed -wa > cptdko_upk27Promoters.bed
bedtools intersect -a cptdko_downk27.bed -b mm10_definedPromoters.bed -wa > cptdko_downk27Promoters.bed
bedtools intersect -a cptdko_nck27.bed -b mm10_definedPromoters.bed -wa > cptdko_ncPromoters.bed

bedtools intersect -a ppardko_upk27.bed -b mm10_definedPromoters.bed -wa > ppardko_upk27Promoters.bed
bedtools intersect -a ppardko_downk27.bed -b mm10_definedPromoters.bed -wa > ppardko_downk27Promoters.bed
bedtools intersect -a ppardko_nck27.bed -b mm10_definedPromoters.bed -wa > ppardko_nck27Promoters.bed

bedtools intersect -a cptwt_upk4.bed -b mm10_definedPromoters.bed -wa > cptwt_upk4Promoters.bed
bedtools intersect -a cptwt_downk4.bed -b mm10_definedPromoters.bed -wa > cptwt_downk4Promoters.bed
bedtools intersect -a cptwt_nck4.bed -b mm10_definedPromoters.bed -wa > cptwt_nck4Promoters.bed

bedtools intersect -a pparwt_upk4.bed -b mm10_definedPromoters.bed -wa > pparwt_upk4Promoters.bed
bedtools intersect -a pparwt_downk4.bed -b mm10_definedPromoters.bed -wa > pparwt_downk4Promoters.bed
bedtools intersect -a pparwt_nck4.bed -b mm10_definedPromoters.bed -wa > pparwt_nck4Promoters.bed

bedtools intersect -a cptdko_upk4.bed -b mm10_definedPromoters.bed -wa > cptdko_upk4Promoters.bed
bedtools intersect -a cptdko_downk4.bed -b mm10_definedPromoters.bed -wa > cptdko_downk4Promoters.bed
bedtools intersect -a cptdko_nck4.bed -b mm10_definedPromoters.bed -wa > cptdko_nck4Promoters.bed





